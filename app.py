from flask import Flask, render_template, request, jsonify, redirect
import os
import google.generativeai as genai
import json

app = Flask(__name__)

# Configura√ß√µes
app.config['SECRET_KEY'] = 'maki-ia-secret-key-2024'

# Configurar API do Google Gemini
GEMINI_API_KEY = 'AIzaSyAw6TehD7zj-Hi3hPkpR-R6Rt7v9ILGK8A'
genai.configure(api_key=GEMINI_API_KEY)

# Configurar modelo Gemini
model = genai.GenerativeModel('gemini-2.5-flash')

def get_maki_response(user_message):
    """Obter resposta da MAKI IA usando Google Gemini"""
    try:
        # Prompt otimizado e inteligente - mais conciso mas completo
        prompt = f"""Voc√™ √© MAKI IA, IA educacional desenvolvida por Jo√£o Guilherme no SESI.

IDENTIDADE: MAKI IA | SESI | "Tecnologia que entende voc√™" | Foco: educa√ß√£o e tecnologia acess√≠vel

PERSONALIDADE: Amig√°vel, educadora, emp√°tica. Explica complexo de forma simples. Sempre encorajadora.

ESTILO: Portugu√™s brasileiro natural. Conversacional. Adapte ao n√≠vel do usu√°rio. Seja objetiva mas completa (m√°x 300 palavras). Use emojis com modera√ß√£o. Evite jarg√µes t√©cnicos sem explica√ß√£o.

FUN√á√ïES ESPECIAIS:
- Se perguntar sobre c√≥digo/programa√ß√£o: explique conceitos e forne√ßa exemplos pr√°ticos quando relevante
- Se perguntar sobre educa√ß√£o: relacione com tecnologia e aprendizagem ativa
- Se perguntar sobre inova√ß√£o: conecte criatividade + tecnologia
- Se sauda√ß√£o: seja calorosa mas breve

Pergunta: {user_message}

Responda como MAKI IA:"""
        
        response = model.generate_content(prompt)
        return response.text.strip()
    except Exception as e:
        print(f"Erro na API Gemini: {str(e)}")
        # Tentar novamente com configura√ß√£o diferente
        try:
            # Configurar novamente a API
            genai.configure(api_key=GEMINI_API_KEY)
            model_retry = genai.GenerativeModel('gemini-1.5-flash')
            response = model_retry.generate_content(prompt)
            return response.text.strip()
        except Exception as e2:
            print(f"Segunda tentativa falhou: {str(e2)}")
            # Fallback para respostas inteligentes locais
            return get_local_maki_response(user_message)

def get_local_maki_response(user_message):
    """Resposta local inteligente e contextual da MAKI IA como fallback"""
    message_lower = user_message.lower().strip()
    
    # An√°lise contextual inteligente
    is_question = '?' in user_message or any(word in message_lower for word in ['como', 'o que', 'qual', 'quando', 'onde', 'por que'])
    is_greeting = any(word in message_lower for word in ['ol√°', 'oi', 'hello', 'hi', 'boa tarde', 'boa noite', 'bom dia', 'tarde', 'noite', 'dia'])
    
    # Respostas contextuais melhoradas
    if is_greeting:
        return "Oi! üëã Sou a MAKI IA do SESI, pronta para tornar tecnologia e educa√ß√£o mais acess√≠veis! Em que posso ajudar?"
    
    elif any(word in message_lower for word in ['intelig√™ncia artificial', 'ia', 'ai', 'artificial intelligence', 'machine learning', 'ml']):
        return "ü§ñ IA √© como ensinar computadores a pensar e aprender! Ela reconhece padr√µes, resolve problemas e cria conte√∫do. Uma ferramenta poderosa para educa√ß√£o. Quer saber mais sobre algum aspecto espec√≠fico?"
    
    elif any(word in message_lower for word in ['programa√ß√£o', 'c√≥digo', 'c√≥digo', 'programar', 'dev', 'developer', 'python', 'javascript', 'java']):
        examples = {
            'python': 'Python √© √≥timo para iniciantes! Sintaxe simples e muito poderosa.',
            'javascript': 'JavaScript roda no navegador e permite criar sites interativos!',
            'java': 'Java √© vers√°til, usado desde apps mobile at√© sistemas empresariais.'
        }
        lang = next((k for k in examples.keys() if k in message_lower), None)
        base = f"üíª Programa√ß√£o √© criar solu√ß√µes atrav√©s de c√≥digo! "
        return base + (examples[lang] if lang else "Qual linguagem te interessa? Posso ajudar a come√ßar!")
    
    elif any(word in message_lower for word in ['tecnologia', 'tech', 'tecnol√≥gico']):
        return "üöÄ Tecnologia democratiza conhecimento e cria inova√ß√£o! No SESI, focamos em tornar tech acess√≠vel. Que √°rea te interessa mais: programa√ß√£o, IA, web ou mobile?"
    
    elif any(word in message_lower for word in ['educa√ß√£o', 'estudar', 'aprender', 'escola', 'ensino']):
        return "üìö Educa√ß√£o + tecnologia = aprendizado transformador! A MAKI foi criada para apoiar estudantes, explicando conceitos complexos de forma simples. Sobre o que quer aprender?"
    
    elif any(word in message_lower for word in ['sesi', 'jo√£o', 'desenvolvedor', 'criador', 'autor']):
        return "‚ú® Fui desenvolvida por Jo√£o Guilherme no SESI para inovar em educa√ß√£o tecnol√≥gica! O SESI √© um excelente ambiente para criar solu√ß√µes educacionais impactantes."
    
    elif any(word in message_lower for word in ['criatividade', 'inova√ß√£o', 'criar', 'ideia', 'projeto']):
        return "üí° Criatividade + tecnologia = solu√ß√µes incr√≠veis! A MAKI estimula pensamento criativo e ajuda a transformar ideias em realidade. Tem alguma ideia em mente?"
    
    elif any(word in message_lower for word in ['ajuda', 'help', 'suporte', 'como usar', 'funciona']):
        return "üÜò Posso ajudar com: tecnologia, programa√ß√£o, educa√ß√£o, inova√ß√£o e mais! Fa√ßa perguntas espec√≠ficas ou explore sugest√µes. Estou aqui para tornar o aprendizado acess√≠vel!"
    
    elif is_question:
        return f"ü§î √ìtima pergunta sobre '{user_message[:50]}'! Como assistente educacional focada em tecnologia, posso ajudar. Que aspecto espec√≠fico te interessa mais?"
    
    else:
        return f"üí¨ Interessante! Sobre '{user_message[:40]}'... Posso ajudar com tecnologia, programa√ß√£o, educa√ß√£o ou inova√ß√£o. Fa√ßa uma pergunta ou explore um t√≥pico!"

@app.route('/')
def index():
    """Redireciona para a p√°gina home"""
    return redirect('/home')

@app.route('/home')
def home():
    """P√°gina principal de apresenta√ß√£o da MAKI IA"""
    return render_template('home.html')

@app.route('/agent')
def agent():
    """P√°gina do modo agent - Interface estilo Claude IA"""
    return render_template('agent.html')

@app.route('/api/info')
def api_info():
    """API endpoint com informa√ß√µes da MAKI IA"""
    return jsonify({
        'nome': 'MAKI IA',
        'desenvolvedor': 'Jo√£o Guilherme',
        'instituicao': 'SESI',
        'slogan': 'Tecnologia que entende voc√™',
        'palavras_chave': ['tecnologia', 'praticidade', 'aprendizado', 'futuro', 'criatividade', 'acessibilidade', 'empatia'],
        'personalidade': {
            'amigavel': True,
            'inteligente': True,
            'curiosa': True,
            'prestativa': True,
            'educadora': True
        },
        'cores': {
            'principal': '#1A237E',  # Azul escuro profundo
            'secundaria': '#2196F3',  # Azul vibrante
            'accent': '#E3F2FD'      # Azul claro
        }
    })

@app.route('/api/list-models')
def list_models():
    """Endpoint para listar modelos dispon√≠veis"""
    try:
        models = list(genai.list_models())
        model_names = [model.name for model in models]
        return jsonify({
            'status': 'success',
            'models': model_names
        })
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': f'Erro ao listar modelos: {str(e)}'
        })

@app.route('/api/test-gemini')
def test_gemini():
    """Endpoint para testar a API do Gemini"""
    try:
        # Teste simples
        test_prompt = "Responda apenas: 'API Gemini funcionando!'"
        response = model.generate_content(test_prompt)
        return jsonify({
            'status': 'success',
            'message': 'API Gemini funcionando!',
            'response': response.text.strip()
        })
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': f'Erro na API Gemini: {str(e)}',
            'error_type': type(e).__name__
        })

@app.route('/api/chat', methods=['POST'])
def api_chat():
    """Endpoint para chat com a MAKI IA"""
    try:
        data = request.get_json()
        user_message = data.get('message', '')
        
        # Validar mensagem vazia
        if not user_message.strip():
            return jsonify({
                'error': 'Mensagem n√£o pode estar vazia',
                'status': 'error'
            }), 400
        
        # Validar limite de 5000 caracteres
        if len(user_message) > 5000:
            return jsonify({
                'error': 'Mensagem muito longa. Por favor, limite sua mensagem a 5000 caracteres.',
                'status': 'error',
                'max_length': 5000,
                'current_length': len(user_message)
            }), 400
        
        # Obter resposta da MAKI IA
        maki_response = get_maki_response(user_message)
        
        return jsonify({
            'response': maki_response,
            'status': 'success'
        })
        
    except Exception as e:
        return jsonify({
            'error': f'Erro interno: {str(e)}',
            'status': 'error'
        }), 500

@app.route('/api/status')
def api_status():
    """Endpoint para verificar status da aplica√ß√£o"""
    return jsonify({
        'status': 'online',
        'versao': '1.0.0',
        'mensagem': 'MAKI IA est√° funcionando perfeitamente!',
        'ai_enabled': True
    })

if __name__ == '__main__':
    # Criar diret√≥rios necess√°rios
    os.makedirs('templates', exist_ok=True)
    os.makedirs('static/css', exist_ok=True)
    os.makedirs('static/js', exist_ok=True)
    os.makedirs('static/images', exist_ok=True)
    
    # Configura√ß√µes para produ√ß√£o
    debug_mode = os.environ.get('FLASK_DEBUG', '0') == '1'
    port = int(os.environ.get('PORT', 5000))
    
    app.run(debug=debug_mode, host='0.0.0.0', port=port)
